name: Build and Release

on:
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type (auto, patch, minor, major)'
        required: false
        default: 'auto'
        type: choice
        options:
          - auto
          - patch
          - minor
          - major

permissions:
  contents: write
  actions: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake \
            build-essential \
            llvm-18-dev \
            libgtest-dev \
            gcc

      - name: Determine version and build
        id: version
        run: |
          # Get version_bump input, default to auto if not set
          VERSION_BUMP_INPUT="${{ github.event.inputs.version_bump }}"
          if [ -z "$VERSION_BUMP_INPUT" ]; then
            VERSION_BUMP_INPUT="auto"
          fi
          
          if [ "$VERSION_BUMP_INPUT" != "auto" ]; then
            BUMP_TYPE="$VERSION_BUMP_INPUT"
          else
            # Get number of files changed in last commit
            FILES_CHANGED=$(git diff --name-only HEAD~1 HEAD 2>/dev/null | wc -l)
            # Get lines changed
            LINES_CHANGED=$(git diff --shortstat HEAD~1 HEAD 2>/dev/null | awk '{print $1+$4}' || echo "0")
            
            echo "Files changed: $FILES_CHANGED"
            echo "Lines changed: $LINES_CHANGED"
            
            # Small change: <= 5 files and <= 100 lines -> patch
            # Medium change: <= 20 files and <= 500 lines -> minor  
            # Large change: anything bigger -> major
            if [ "$FILES_CHANGED" -le 5 ] && [ "$LINES_CHANGED" -le 100 ]; then
              BUMP_TYPE="patch"
            elif [ "$FILES_CHANGED" -le 20 ] && [ "$LINES_CHANGED" -le 500 ]; then
              BUMP_TYPE="minor"
            else
              BUMP_TYPE="major"
            fi
          fi
          
          echo "Bump type: $BUMP_TYPE"
          
          # Read current version
          MAJOR=$(grep -oP 'OMSCRIPT_VERSION_MAJOR \K\d+' include/version.h)
          MINOR=$(grep -oP 'OMSCRIPT_VERSION_MINOR \K\d+' include/version.h)
          PATCH=$(grep -oP 'OMSCRIPT_VERSION_PATCH \K\d+' include/version.h)
          
          echo "Current version: $MAJOR.$MINOR.$PATCH"
          
          # Calculate new version
          if [ "$BUMP_TYPE" = "major" ]; then
            NEW_MAJOR=$((MAJOR + 1))
            NEW_MINOR=0
            NEW_PATCH=0
          elif [ "$BUMP_TYPE" = "minor" ]; then
            NEW_MAJOR=$MAJOR
            NEW_MINOR=$((MINOR + 1))
            NEW_PATCH=0
          else
            NEW_MAJOR=$MAJOR
            NEW_MINOR=$MINOR
            NEW_PATCH=$((PATCH + 1))
          fi
          
          NEW_VERSION="$NEW_MAJOR.$NEW_MINOR.$NEW_PATCH"
          echo "New version: $NEW_VERSION"
          
          # Update version header
          sed -i "s/\(#define OMSCRIPT_VERSION_MAJOR \)[0-9]*/\1$NEW_MAJOR/" include/version.h
          sed -i "s/\(#define OMSCRIPT_VERSION_MINOR \)[0-9]*/\1$NEW_MINOR/" include/version.h
          sed -i "s/\(#define OMSCRIPT_VERSION_PATCH \)[0-9]*/\1$NEW_PATCH/" include/version.h
          sed -i "s/\(#define OMSCRIPT_VERSION_STRING \"\)[^\"]*/\1$NEW_VERSION/" include/version.h
          
          cat include/version.h
          
          # Configure and build
          cmake -B build -DCMAKE_BUILD_TYPE=Release
          cmake --build build --parallel $(nproc)
          
          # Run tests
          ctest --test-dir build --output-on-failure
          
          # Create release
          mkdir -p release
          cp build/omsc release/omsc
          chmod +x release/omsc
          
          # Create archive
          ARCHIVE_NAME="omscript-${NEW_VERSION}-linux-x86_64.tar.gz"
          tar -czf "$ARCHIVE_NAME" -C release omsc
          zip -j "omscript-${NEW_VERSION}-linux-x86_64.zip" release/omsc
          
          echo "Created archives: $ARCHIVE_NAME"
          
          # Create release body
          {
            echo "## OmScript v${NEW_VERSION}"
            echo ""
            echo "**Version bump:** $BUMP_TYPE"
            echo ""
            echo "### Installation"
            echo ""
            echo "Run: \`./omsc install\` for user install or \`sudo ./omsc install\` for system-wide."
            echo ""
            echo "### Quick Start"
            echo ""
            echo "\`\`\`bash"
            echo "# Compile a file"
            echo "omsc script.om"
            echo ""
            echo "# Show version"
            echo "omsc --version"
            echo "\`\`\`"
          } > /tmp/release_body.txt
          
          # Commit version update and push tag
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add include/version.h
          git commit -m "Bump version to $NEW_VERSION"
          git tag "v${NEW_VERSION}"
          git push --follow-tags
          
          # Set outputs
          echo "VERSION=$NEW_VERSION" >> "$GITHUB_OUTPUT"
          echo "BUMP_TYPE=$BUMP_TYPE" >> "$GITHUB_OUTPUT"
          echo "ARCHIVE_NAME=$ARCHIVE_NAME" >> "$GITHUB_OUTPUT"

      - name: Trigger release workflow
        run: |
          # GITHUB_TOKEN push events don't trigger other workflows, so we
          # explicitly dispatch the release workflow via the API.
          curl -s -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/release.yml/dispatches" \
            -d "{\"ref\":\"main\",\"inputs\":{\"version\":\"${{ steps.version.outputs.VERSION }}\"}}"
