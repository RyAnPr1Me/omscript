name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g. 1.2.3, without the leading v)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux-x86_64
            binary: omsc
            archive_ext: tar.gz
          - os: macos-latest
            platform: macos-arm64
            binary: omsc
            archive_ext: tar.gz
          - os: windows-latest
            platform: windows-x86_64
            binary: omsc.exe
            archive_ext: zip

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        shell: bash
        run: |
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          elif [[ -n "${{ github.event.inputs.version }}" ]]; then
            VERSION="${{ github.event.inputs.version }}"
            if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              echo "Error: version input must be a semantic version (e.g. 1.2.3)"
              exit 1
            fi
          else
            echo "Error: workflow must be triggered by a version tag (e.g. v1.2.3) or provide a version input"
            exit 1
          fi
          echo "VERSION=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake \
            build-essential \
            llvm-18-dev \
            libgtest-dev \
            gcc

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install cmake llvm
          echo "LLVM_DIR=$(brew --prefix llvm)/lib/cmake/llvm" >> "$GITHUB_ENV"

      - name: Install dependencies (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $llvmDir = "C:\Program Files\LLVM\lib\cmake\llvm"
          if (Test-Path (Join-Path $llvmDir "LLVMConfig.cmake")) {
            Write-Host "LLVM cmake config already available at: $llvmDir"
          } else {
            $llvmVersion = "18.1.8"
            $installerUrl = "https://github.com/llvm/llvm-project/releases/download/llvmorg-$llvmVersion/LLVM-$llvmVersion-win64.exe"
            $installerPath = Join-Path $env:RUNNER_TEMP "LLVM-installer.exe"
            Write-Host "Downloading LLVM $llvmVersion..."
            curl.exe --fail -L -o $installerPath $installerUrl
            if (-not (Test-Path $installerPath)) {
              Write-Error "Failed to download LLVM installer"
              exit 1
            }
            # Extract with 7z instead of running the NSIS installer so that
            # cmake development files (LLVMConfig.cmake) are always present.
            $llvmRoot = "C:\LLVM"
            Write-Host "Extracting LLVM $llvmVersion to $llvmRoot..."
            & 7z x $installerPath "-o$llvmRoot" -y > $null
            if ($LASTEXITCODE -ne 0) {
              Write-Error "Failed to extract LLVM installer with 7z (exit code $LASTEXITCODE)"
              exit 1
            }
            $configFile = Get-ChildItem -Path $llvmRoot -Recurse -Filter "LLVMConfig.cmake" -ErrorAction SilentlyContinue | Select-Object -First 1
            if ($configFile) {
              $llvmDir = $configFile.DirectoryName
              Write-Host "Found LLVMConfig.cmake at: $llvmDir"
            } else {
              Write-Host "Contents of ${llvmRoot}:"
              Get-ChildItem -Path $llvmRoot -Recurse -ErrorAction SilentlyContinue | ForEach-Object { Write-Host $_.FullName }
              Write-Error "LLVMConfig.cmake not found in LLVM package"
              exit 1
            }
          }
          $llvmDirFwd = $llvmDir -replace '\\','/'
          echo "LLVM_DIR=$llvmDirFwd" >> $env:GITHUB_ENV

      - name: Configure CMake
        shell: bash
        run: |
          cmake_args=(-DCMAKE_BUILD_TYPE=Release "-DOMSC_VERSION=${{ steps.version.outputs.VERSION }}")
          if [ -n "${LLVM_DIR:-}" ]; then
            cmake_args+=("-DLLVM_DIR=$LLVM_DIR")
          fi
          cmake -B build "${cmake_args[@]}"

      - name: Build compiler
        shell: bash
        run: cmake --build build --config Release --parallel 4

      - name: Run unit tests (Linux)
        if: runner.os == 'Linux'
        run: cd build && ctest --output-on-failure

      - name: Run integration tests (Linux)
        if: runner.os == 'Linux'
        run: bash run_tests.sh

      - name: Package binary (Unix)
        if: runner.os != 'Windows'
        run: |
          mkdir -p release
          cp build/${{ matrix.binary }} release/omsc-${{ matrix.platform }}
          chmod +x release/omsc-${{ matrix.platform }}
          tar -czf release/omsc-${{ steps.version.outputs.VERSION }}-${{ matrix.platform }}.tar.gz \
            -C release omsc-${{ matrix.platform }}

      - name: Package binary (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          mkdir -p release
          cp build/Release/${{ matrix.binary }} release/omsc-${{ matrix.platform }}.exe
          cd release && 7z a omsc-${{ steps.version.outputs.VERSION }}-${{ matrix.platform }}.zip omsc-${{ matrix.platform }}.exe

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: omsc-${{ matrix.platform }}
          path: release/omsc-${{ steps.version.outputs.VERSION }}-${{ matrix.platform }}.${{ matrix.archive_ext }}

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Extract version
        id: version
        shell: bash
        run: |
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION="${{ github.event.inputs.version }}"
          fi
          echo "VERSION=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release
          merge-multiple: true

      - name: List release files
        run: ls -la release/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.VERSION }}
          name: OmScript v${{ steps.version.outputs.VERSION }}
          body: |
            ## OmScript v${{ steps.version.outputs.VERSION }}

            ### Downloads

            | Platform | Architecture | File |
            |----------|-------------|------|
            | Linux | x86_64 | `omsc-${{ steps.version.outputs.VERSION }}-linux-x86_64.tar.gz` |
            | macOS | ARM64 (Apple Silicon) | `omsc-${{ steps.version.outputs.VERSION }}-macos-arm64.tar.gz` |
            | Windows | x86_64 | `omsc-${{ steps.version.outputs.VERSION }}-windows-x86_64.zip` |

            ### Installation

            **Linux / macOS:**
            ```bash
            tar -xzf omsc-${{ steps.version.outputs.VERSION }}-<platform>.tar.gz
            chmod +x omsc-<platform>
            sudo mv omsc-<platform> /usr/local/bin/omsc
            ```

            **Windows:**
            1. Extract `omsc-${{ steps.version.outputs.VERSION }}-windows-x86_64.zip`
            2. Add the extracted directory to your PATH

            Or use the built-in installer on any platform:
            ```bash
            ./omsc install
            ```

            ### Requirements
            - LLVM 18 runtime libraries
            - GCC (Linux) / Clang (macOS) / MSVC (Windows) for linking
          files: |
            release/*
          draft: false
          prerelease: false
